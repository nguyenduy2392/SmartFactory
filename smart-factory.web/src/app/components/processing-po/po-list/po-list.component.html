<div class="card">
  <div *ngIf="!hideHeader" class="flex justify-content-between align-items-center mb-4">
    <h2 class="text-2xl font-bold m-0">
      <i class="pi pi-file-import mr-2"></i>
      Quản lý Processing PO
    </h2>
    <p-button label="Import PO từ Excel" icon="pi pi-upload" (onClick)="openImportDialog()"
      styleClass="p-button-success">
    </p-button>
  </div>

  <!-- Import Button when header is hidden -->
  <div *ngIf="hideHeader" class="flex justify-content-end">
    <p-button label="Import PO từ Excel" icon="pi pi-upload" (onClick)="openImportDialog()"
      styleClass="p-button-success">
    </p-button>
  </div>

  <!-- Filters -->
  <div class="grid mb-4">
    <div class="col-12 md:col-3">
      <label for="status" class="block mb-2">Trạng thái</label>
      <p-dropdown id="status" [options]="statusOptions" [(ngModel)]="selectedStatus" optionLabel="label"
        optionValue="value" placeholder="Chọn trạng thái" [style]="{'width': '100%'}" (onChange)="applyFilters()">
      </p-dropdown>
    </div>

    <div class="col-12 md:col-3">
      <label for="processingType" class="block mb-2">Loại gia công</label>
      <p-dropdown id="processingType" [options]="processingTypeOptions" [(ngModel)]="selectedProcessingType"
        optionLabel="label" optionValue="value" placeholder="Chọn loại gia công" [style]="{'width': '100%'}"
        (onChange)="applyFilters()">
      </p-dropdown>
    </div>

    <div class="col-12 md:col-3" *ngIf="!customerId">
      <label for="customer" class="block mb-2">Chủ hàng</label>
      <p-dropdown id="customer" [options]="customers" [(ngModel)]="selectedCustomerId" optionLabel="name"
        optionValue="id" placeholder="Chọn chủ hàng" [style]="{'width': '100%'}" [filter]="true" filterBy="name"
        (onChange)="applyFilters()">
      </p-dropdown>
    </div>

    <div class="col-12" [class.md:col-3]="!customerId" [class.md:col-6]="customerId">
      <label for="search" class="block mb-2">Tìm kiếm</label>
      <span class="p-input-icon-left w-full">
        <i class="pi pi-search"></i>
        <input pInputText id="search" type="text" [(ngModel)]="searchText" (input)="onSearch()"
          placeholder="Tìm theo số PO, chủ hàng..." class="w-full">
      </span>
    </div>
  </div>

  <!-- PO Table -->
  <div class="table-card">
    <div class="table-wrapper">
      <table class="po-table">
        <thead>
          <tr>
            <th class="text-center" style="width: 60px;">STT</th>
            <th>Số PO</th>
            <th *ngIf="!customerId">Chủ hàng</th>
            <th>Loại gia công</th>
            <th>Ngày PO</th>
            <th class="text-center">Trạng thái NVL</th>
            <th class="text-center">Thao tác</th>
          </tr>
        </thead>
        <tbody *ngIf="paginatedPurchaseOrders.length > 0">
          <tr *ngFor="let po of paginatedPurchaseOrders; let i = index" class="table-row">
            <td class="text-center">
              {{ getRowNumber(i) }}
            </td>
            <td>
              <a href="javascript:void(0)" (click)="viewPODetail(po)">{{ po.poNumber }}</a>
            </td>
            <td *ngIf="!customerId">{{ po.customerName }}</td>
            <td>
              <span class="status-badge status-info">{{ getProcessingTypeLabel(po.processingType) }}</span>
            </td>
            <td>{{ po.poDate | date:'dd/MM/yyyy' }}</td>
            <td class="text-center">
              <span [class]="po.isMaterialFullyReceived ? 'status-badge status-success' : 'status-badge status-warning'">
                {{ po.isMaterialFullyReceived ? 'Đã hoàn thành' : 'Chưa đủ' }}
              </span>
            </td>
            <td class="text-center">
              <button pButton icon="pi pi-bars"
                class="p-button-soft p-button-primary p-button-sm p-button-rounded action-menu-btn" pTooltip="Thao tác"
                (click)="showActionMenu($event, po); actionMenu.toggle($event)">
              </button>
            </td>
          </tr>
        </tbody>
        <tbody *ngIf="paginatedPurchaseOrders.length === 0 && !loading">
          <tr>
            <td [attr.colspan]="customerId ? 6 : 7" class="text-center py-8">
              <i class="pi pi-inbox text-6xl mb-3 block text-gray-300"></i>
              <p class="text-lg font-medium text-gray-500">Không có PO nào</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="table-footer" *ngIf="filteredPurchaseOrders.length > 0">
      <div class="pagination-info">
        Hiển thị <span class="font-bold">{{ getFirstRecord() }}</span> đến
        <span class="font-bold">{{ getLastRecord() }}</span> trong tổng số
        <span class="font-bold">{{ filteredPurchaseOrders.length }}</span> PO
      </div>
      <div class="flex gap-2 align-items-center">
        <button pButton label="Trang trước" icon="pi pi-chevron-left" class="p-button-soft p-button-primary p-button-sm"
          [disabled]="currentPage === 1" (click)="previousPage()">
        </button>
        <div class="flex gap-1 page-numbers">
          <button *ngFor="let page of getPageNumbers()" pButton [label]="page.toString()"
            [class]="page === currentPage ? 'p-button-sm p-button-primary' : 'p-button-sm p-button-text'"
            (click)="goToPage(page)">
          </button>
        </div>
        <button pButton label="Trang sau" icon="pi pi-chevron-right" iconPos="right"
          class="p-button-soft p-button-primary p-button-sm" [disabled]="currentPage >= getTotalPages()"
          (click)="nextPage()">
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Action Menu -->
<p-menu #actionMenu [model]="actionMenuItems" [popup]="true"></p-menu>

<!-- Import Dialog - will be opened via UiModalService -->