<div class="stock-in-container">
  <div class="page-header">
    <div class="header-content">
      <i class="pi pi-inbox header-icon"></i>
      <div>
        <h2 class="header-title">Nhập Kho Nguyên Vật Liệu</h2>
        <p class="header-subtitle">Quản lý phiếu nhập kho nguyên vật liệu</p>
      </div>
    </div>
  </div>

  <form [formGroup]="stockInForm" (ngSubmit)="onSubmit()">
    <div class="form-card">
      <h3 class="section-title">
        <i class="pi pi-info-circle mr-2"></i>
        Thông Tin Chung
      </h3>
      <div class="grid">
      <!-- Customer -->
      <div class="col-12 md:col-6">
        <div class="field">
          <label for="customerId">
            Khách Hàng <span class="text-red-500">*</span>
          </label>
          <p-dropdown
            id="customerId"
            formControlName="customerId"
            [options]="customers"
            optionLabel="name"
            optionValue="id"
            placeholder="Chọn khách hàng"
            [showClear]="true"
            [filter]="true"
            filterBy="name,code"
            (onChange)="onCustomerChange($event)"
            styleClass="w-full">
          </p-dropdown>
          <small class="p-error" *ngIf="stockInForm.get('customerId')?.invalid && stockInForm.get('customerId')?.touched">
            Vui lòng chọn khách hàng
          </small>
        </div>
      </div>

      <!-- PO Selection -->
      <div class="col-12 md:col-6">
        <div class="field">
          <label for="poNumber">
            PO Liên Quan
          </label>
          <div class="p-inputgroup">
            <p-autoComplete
              id="poNumber"
              formControlName="poNumber"
              [suggestions]="filteredPOs"
              (completeMethod)="onSearchPO($event)"
              (onSelect)="onSelectPO($event)"
              (onClear)="onClearPO()"
              field="poNumber"
              [dropdown]="true"
              [disabled]="!stockInForm.get('customerId')?.value"
              placeholder="Chọn khách hàng trước..."
              styleClass="w-full">
              <ng-template let-po pTemplate="item">
                <div class="flex align-items-center">
                  <div>
                    <div class="font-semibold">{{ po.poNumber }}</div>
                    <div class="text-sm text-500">{{ po.customerName }}</div>
                    <div class="text-xs">
                      <span class="mr-2">{{ po.poDate | date:'dd/MM/yyyy' }}</span>
                      <span class="p-tag p-tag-sm" 
                            [ngClass]="po.isMaterialFullyReceived ? 'p-tag-success' : 'p-tag-warning'">
                        {{ po.isMaterialFullyReceived ? 'Đã hoàn thành' : 'Chưa đủ' }}
                      </span>
                    </div>
                  </div>
                </div>
              </ng-template>
            </p-autoComplete>
            <button 
              *ngIf="selectedPO" 
              type="button" 
              pButton 
              icon="pi pi-times" 
              (click)="onClearPO()"
              class="p-button-danger">
            </button>
          </div>
          <small class="text-500" *ngIf="stockInForm.get('customerId')?.value">Chọn PO liên quan đến khách hàng (tùy chọn)</small>
          <small class="p-error" *ngIf="!stockInForm.get('customerId')?.value">Vui lòng chọn khách hàng trước</small>
        </div>
      </div>

      <!-- Warehouse -->
      <div class="col-12 md:col-6">
        <div class="field">
          <label for="warehouseId">
            Kho Nhập <span class="text-red-500">*</span>
          </label>
          <p-dropdown
            id="warehouseId"
            formControlName="warehouseId"
            [options]="warehouses"
            optionLabel="name"
            optionValue="id"
            placeholder="Chọn kho"
            [showClear]="true"
            styleClass="w-full">
          </p-dropdown>
          <small class="p-error" *ngIf="stockInForm.get('warehouseId')?.invalid && stockInForm.get('warehouseId')?.touched">
            Vui lòng chọn kho
          </small>
        </div>
      </div>

      <!-- Receipt Date -->
      <div class="col-12 md:col-6">
        <div class="field">
          <label for="receiptDate">
            Ngày Nhập <span class="text-red-500">*</span>
          </label>
          <p-calendar
            id="receiptDate"
            formControlName="receiptDate"
            dateFormat="dd/mm/yy"
            [showIcon]="true"
            [showButtonBar]="true"
            styleClass="w-full">
          </p-calendar>
          <small class="p-error" *ngIf="stockInForm.get('receiptDate')?.invalid && stockInForm.get('receiptDate')?.touched">
            Vui lòng chọn ngày nhập
          </small>
        </div>
      </div>

      <!-- Receipt Number -->
      <div class="col-12 md:col-6">
        <div class="field">
          <label for="receiptNumber">
            Số Phiếu Nhập <span class="text-red-500">*</span>
          </label>
          <input
            id="receiptNumber"
            type="text"
            pInputText
            formControlName="receiptNumber"
            placeholder="Ví dụ: PN-2026-001"
            class="w-full" />
          <small class="p-error" *ngIf="stockInForm.get('receiptNumber')?.invalid && stockInForm.get('receiptNumber')?.touched">
            Vui lòng nhập số phiếu
          </small>
        </div>
      </div>

      <!-- Notes -->
      <div class="col-12">
        <div class="field">
          <label for="notes">Ghi Chú</label>
          <textarea
            id="notes"
            pInputTextarea
            formControlName="notes"
            rows="3"
            placeholder="Ghi chú nhập kho..."
            class="w-full">
          </textarea>
        </div>
      </div>
      </div>
    </div>

    <!-- Materials Table -->
    <div class="form-card mt-3">
      <div class="flex align-items-center justify-content-between mb-3">
        <h3 class="section-title m-0">
          <i class="pi pi-list mr-2"></i>
          Danh Sách Nguyên Vật Liệu
        </h3>
        <button
          type="button"
          pButton
          icon="pi pi-plus"
          label="Thêm Dòng"
          (click)="addMaterialRow()"
          class="p-button-success">
        </button>
      </div>

      <p-table
        [value]="materialsArray.controls"
        styleClass="p-datatable-sm"
        [scrollable]="true"
        scrollHeight="400px">
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 3rem">#</th>
            <th style="width: 20%">Nguyên Vật Liệu <span class="text-red-500">*</span></th>
            <th style="width: 10%">Số Lượng <span class="text-red-500">*</span></th>
            <th style="width: 10%">Đơn Vị <span class="text-red-500">*</span></th>
            <th style="width: 12%">Số Lô</th>
            <th style="width: 15%">Ghi Chú</th>
            <th style="width: 5rem"></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-materialForm let-i="rowIndex">
          <tr [formGroup]="materialForm">
            <td>{{ i + 1 }}</td>
            <td>
              <p-dropdown
                formControlName="materialId"
                [options]="filteredMaterials"
                optionLabel="name"
                optionValue="id"
                placeholder="Chọn NVL"
                [filter]="true"
                filterBy="name,code"
                (onChange)="onMaterialChange(i)"
                [appendTo]="'body'"
                styleClass="w-full">
                <ng-template let-material pTemplate="item">
                  <div>
                    <div class="font-semibold">{{ material.name }}</div>
                    <div class="text-sm text-500">{{ material.code }}</div>
                  </div>
                </ng-template>
              </p-dropdown>
            </td>
            <td>
              <p-inputNumber
                formControlName="quantity"
                [minFractionDigits]="0"
                [maxFractionDigits]="3"
                [min]="0"
                styleClass="w-full">
              </p-inputNumber>
            </td>
            <td>
              <p-dropdown
                formControlName="unit"
                [options]="unitsOfMeasure"
                optionLabel="name"
                optionValue="name"
                placeholder="Chọn đơn vị"
                [filter]="true"
                filterBy="name,code"
                appendTo="body"
                styleClass="w-full">
                <ng-template let-unit pTemplate="item">
                  <div>
                    <div class="font-semibold">{{ unit.name }}</div>
                    <div class="text-sm text-500">{{ unit.code }}</div>
                  </div>
                </ng-template>
              </p-dropdown>
            </td>
            <td>
              <input
                type="text"
                pInputText
                formControlName="batchNumber"
                placeholder="BATCH-001"
                class="w-full" />
            </td>
            <td>
              <input
                type="text"
                pInputText
                formControlName="notes"
                class="w-full" />
            </td>
            <td>
              <button
                type="button"
                pButton
                icon="pi pi-trash"
                (click)="removeMaterialRow(i)"
                class="p-button-danger p-button-sm"
                [disabled]="materialsArray.length === 1">
              </button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button
        type="button"
        pButton
        label="Hủy"
        icon="pi pi-times"
        (click)="resetForm()"
        class="p-button-secondary p-button-lg"
        [disabled]="submitting">
      </button>
      <button
        type="submit"
        pButton
        label="Lưu Phiếu Nhập"
        icon="pi pi-save"
        [loading]="submitting"
        class="p-button-success p-button-lg">
      </button>
    </div>
  </form>
</div>
