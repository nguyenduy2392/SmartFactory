<div class="surface-ground page">
  <!-- Header -->
  <div class="flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Quản lý nguyên vật liệu</h2>
    <div class="flex align-items-center gap-2">
      <p-dropdown 
        [options]="customers" 
        [(ngModel)]="selectedCustomerId"
        name="selectedCustomerId"
        optionLabel="name" 
        optionValue="id"
        placeholder="Lọc theo chủ hàng"
        [showClear]="true"
        styleClass="w-15rem"
        (onChange)="onCustomerFilterChange()">
      </p-dropdown>
      <p-button 
        label="Thêm nguyên vật liệu" 
        icon="pi pi-plus" 
        (onClick)="openCreateDialog()">
      </p-button>
    </div>
  </div>

  <!-- Table -->
  <p-table 
    [value]="materials"
    [loading]="loading"
    [paginator]="true"
    [rows]="10"
    [rowsPerPageOptions]="[10, 25, 50]"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} bản ghi"
    styleClass="p-datatable-gridlines">
    
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 12%">Mã NVL</th>
        <th style="width: 20%">Tên nguyên vật liệu</th>
        <th style="width: 15%">Chủ hàng</th>
        <th style="width: 12%">Loại</th>
        <th style="width: 10%">Tồn kho</th>
        <th style="width: 8%">Đơn vị</th>
        <th style="width: 10%">Trạng thái</th>
        <th style="width: 13%">Thao tác</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-material>
      <tr>
        <td>{{ material.code }}</td>
        <td>{{ material.name }}</td>
        <td>
          <span *ngIf="material.customerName">{{ material.customerName }}</span>
          <span *ngIf="!material.customerName && material.customerCode">{{ material.customerCode }}</span>
          <span *ngIf="!material.customerName && !material.customerCode" class="text-gray-400">-</span>
        </td>
        <td>{{ material.type }}</td>
        <td>
          <p-tag 
            [value]="material.currentStock + ' / ' + material.minStock" 
            [severity]="getStockSeverity(material.currentStock, material.minStock)">
          </p-tag>
        </td>
        <td>{{ material.unit }}</td>
        <td>
          <p-tag 
            [value]="material.isActive ? 'Hoạt động' : 'Ngừng'" 
            [severity]="getStatusSeverity(material.isActive)">
          </p-tag>
        </td>
        <td>
          <p-button 
            icon="pi pi-pencil" 
            [rounded]="true"
            [text]="true"
            severity="info"
            (onClick)="openEditDialog(material)"
            pTooltip="Sửa">
          </p-button>
        </td>
      </tr>
    </ng-template>
    
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8" class="text-center">Không có dữ liệu</td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Dialog Form -->
<p-dialog 
  [(visible)]="showDialog" 
  [header]="isEdit ? 'Sửa nguyên vật liệu' : 'Thêm nguyên vật liệu mới'"
  [modal]="true" 
  [style]="{ width: '50vw' }"
  [draggable]="false"
  [resizable]="false">
  
  <div class="grid p-fluid">
    <div class="col-12">
      <label for="customerId" class="block mb-2">Chủ hàng (Tùy chọn)</label>
      <p-dropdown 
        id="customerId"
        [options]="customers" 
        [(ngModel)]="materialForm.customerId"
        name="customerId"
        optionLabel="name" 
        optionValue="id"
        placeholder="Chọn chủ hàng (nếu có)"
        [showClear]="true"
        styleClass="w-full">
      </p-dropdown>
    </div>

    <div class="col-6">
      <label for="code" class="block mb-2">Mã nguyên vật liệu <span class="text-red-500">*</span></label>
      <input 
        pInputText 
        id="code" 
        [(ngModel)]="materialForm.code" 
        name="code" 
        placeholder="Ví dụ: NVL001"
        class="w-full" 
        required />
    </div>

    <div class="col-6">
      <label for="name" class="block mb-2">Tên nguyên vật liệu <span class="text-red-500">*</span></label>
      <input 
        pInputText 
        id="name" 
        [(ngModel)]="materialForm.name" 
        name="name" 
        placeholder="Ví dụ: Nhựa ABS"
        class="w-full" 
        required />
    </div>

    <div class="col-6">
      <label for="type" class="block mb-2">Loại vật tư</label>
      <p-dropdown 
        id="type"
        [options]="materialTypes" 
        [(ngModel)]="materialForm.type"
        optionLabel="label" 
        optionValue="value"
        placeholder="Chọn loại"
        styleClass="w-full"
        name="type">
      </p-dropdown>
    </div>

    <div class="col-6">
      <label for="unit" class="block mb-2">Đơn vị tính <span class="text-red-500">*</span></label>
      <p-dropdown 
        id="unit"
        [options]="units" 
        [(ngModel)]="materialForm.unit"
        optionLabel="name" 
        optionValue="code"
        placeholder="Chọn đơn vị"
        styleClass="w-full"
        name="unit">
      </p-dropdown>
    </div>

    <div class="col-6">
      <label for="colorCode" class="block mb-2">Mã màu</label>
      <input 
        pInputText 
        id="colorCode" 
        [(ngModel)]="materialForm.colorCode" 
        name="colorCode" 
        placeholder="Ví dụ: PMS 340C"
        class="w-full" />
    </div>

    <div class="col-12 flex align-items-center">
      <p-checkbox 
        [(ngModel)]="materialForm.isActive" 
        [binary]="true" 
        inputId="isActive"
        name="isActive">
      </p-checkbox>
      <label for="isActive" class="ml-2">Hoạt động</label>
    </div>

    <div class="col-12">
      <label for="description" class="block mb-2">Mô tả</label>
      <textarea 
        pInputTextarea 
        id="description" 
        [(ngModel)]="materialForm.description" 
        name="description" 
        rows="3"
        placeholder="Mô tả về nguyên vật liệu"
        class="w-full">
      </textarea>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <p-button 
      label="Hủy" 
      icon="pi pi-times" 
      severity="secondary"
      [text]="true"
      (onClick)="showDialog = false">
    </p-button>
    <p-button 
      label="Lưu" 
      icon="pi pi-check" 
      (onClick)="saveMaterial()">
    </p-button>
  </ng-template>
</p-dialog>

<p-toast></p-toast>

